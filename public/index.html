<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PowerHODL - ETH/BTC Trading System</title>
    
    <!-- Chart.js for professional charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #0a0a0b;
            color: #ffffff;
            overflow-x: auto;
        }

        .header {
            background: #1a1a1b;
            border-bottom: 1px solid #2d2d30;
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .logo {
            font-weight: 600;
            font-size: 18px;
            color: #00d4aa;
        }

        .nav-item {
            color: #b3b3b3;
            font-size: 14px;
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .nav-item.active {
            background: #2d2d30;
            color: #ffffff;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
            color: #b3b3b3;
            font-size: 14px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #00d4aa;
        }

        .main-container {
            padding: 24px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .balance-section {
            margin-bottom: 32px;
        }

        .balance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .balance-title {
            font-size: 14px;
            color: #b3b3b3;
            font-weight: 400;
        }

        .total-balance {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .balance-change {
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .positive {
            color: #00d4aa;
        }

        .negative {
            color: #ff6b6b;
        }

        .assets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .asset-card {
            background: #1a1a1b;
            border: 1px solid #2d2d30;
            border-radius: 8px;
            padding: 20px;
        }

        .asset-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .asset-name {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .asset-symbol {
            font-size: 14px;
            color: #b3b3b3;
        }

        .asset-balance {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .asset-value {
            font-size: 14px;
            color: #b3b3b3;
        }

        .asset-change {
            font-size: 14px;
            font-weight: 500;
        }

        .charts-section {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
            margin-bottom: 32px;
        }

        .chart-container {
            background: #1a1a1b;
            border: 1px solid #2d2d30;
            border-radius: 8px;
            padding: 20px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 500;
        }

        .timeframe-selector {
            display: flex;
            gap: 4px;
        }

        .timeframe-btn {
            background: none;
            border: none;
            color: #b3b3b3;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .timeframe-btn.active {
            background: #00d4aa;
            color: #000;
        }

        .trading-signal {
            background: #1a1a1b;
            border: 1px solid #2d2d30;
            border-radius: 8px;
            padding: 20px;
        }

        .signal-header {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 16px;
        }

        .signal-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
        }

        .signal-action {
            font-size: 18px;
            font-weight: 600;
            padding: 8px 16px;
            border-radius: 6px;
            background: #2d2d30;
        }

        .signal-hold {
            color: #fbbf24;
        }

        .signal-buy {
            color: #00d4aa;
        }

        .signal-sell {
            color: #ff6b6b;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .metric-label {
            color: #b3b3b3;
        }

        .metric-value {
            font-weight: 500;
        }

        .trades-section {
            background: #1a1a1b;
            border: 1px solid #2d2d30;
            border-radius: 8px;
            padding: 20px;
        }

        .trades-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .trades-title {
            font-size: 16px;
            font-weight: 500;
        }

        .table-container {
            overflow-x: auto;
        }

        .trades-table {
            width: 100%;
            border-collapse: collapse;
        }

        .trades-table th,
        .trades-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #2d2d30;
            font-size: 14px;
        }

        .trades-table th {
            color: #b3b3b3;
            font-weight: 500;
            background: #131314;
        }

        .trades-table td {
            color: #ffffff;
        }

        .refresh-btn {
            background: #00d4aa;
            color: #000;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .refresh-btn:hover {
            background: #00b894;
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        @media (max-width: 768px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
            
            .assets-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <div class="logo">PowerHODL</div>
            <span class="nav-item active">Live Trading Dashboard</span>
            <div style="font-size: 12px; color: #fbbf24; margin-top: 4px; font-weight: 500;">
                üéØ Mission: Accumulate BTC through ETH/BTC ratio trading
            </div>
        </div>
        <div class="header-right">
            <div class="status-indicator">
                <div class="status-dot"></div>
                <span id="connection-status">Connected</span>
            </div>
            <span id="last-update">--</span>
        </div>
    </header>

    <div class="main-container">
        <!-- Balance Section -->
        <div class="balance-section">
            <div class="balance-header">
                <div class="balance-title">Total BTC Accumulated</div>
                <button class="refresh-btn" onclick="refreshData()">Refresh</button>
            </div>
            <div class="total-balance" id="total-balance">0.00000000 BTC</div>
            <div class="balance-change" id="balance-change">
                <span id="btc-change-amount">+0.00000000 BTC</span>
                <span id="btc-change-percent">+0.00%</span>
            </div>
        </div>

        <!-- Assets Grid -->
        <div class="assets-grid">
            <div class="asset-card">
                <div class="asset-header">
                    <div class="asset-name">
                        <span>Bitcoin</span>
                        <span class="asset-symbol">BTC</span>
                    </div>
                </div>
                <div class="asset-balance" id="btc-balance">0.00000 BTC</div>
                <div class="asset-value" id="btc-value">Direct Holdings</div>
                <div class="asset-change positive" id="btc-change">+0.00%</div>
            </div>

            <div class="asset-card">
                <div class="asset-header">
                    <div class="asset-name">
                        <span>Ethereum</span>
                        <span class="asset-symbol">ETH</span>
                    </div>
                </div>
                <div class="asset-balance" id="eth-balance">0.00000 ETH</div>
                <div class="asset-value" id="eth-value">ETH Holdings</div>
                <div class="asset-change positive" id="eth-change">+0.00%</div>
            </div>

            <div class="asset-card">
                <div class="asset-header">
                    <div class="asset-name">
                        <span>ETH/BTC Ratio</span>
                        <span class="asset-symbol">CURRENT</span>
                    </div>
                </div>
                <div class="asset-balance" id="eth-btc-ratio">0.000000</div>
                <div class="asset-value" id="ratio-age">--</div>
                <div class="asset-change" id="ratio-change">--</div>
            </div>
        </div>

        <!-- Charts and Signal Section -->
        <div class="charts-section">
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">BTC Accumulation Over Time</div>
                    <div class="timeframe-selector">
                        <button class="timeframe-btn active">1D</button>
                        <button class="timeframe-btn">7D</button>
                        <button class="timeframe-btn">1M</button>
                        <button class="timeframe-btn">3M</button>
                        <button class="timeframe-btn">1Y</button>
                    </div>
                </div>
                <div style="position: relative; height: 300px; width: 100%;">
                    <canvas id="balanceChart"></canvas>
                </div>
            </div>

            <!-- Secondary Dollar Value Chart (Reference Only) -->
            <div class="chart-container" style="margin-bottom: 32px;">
                <div class="chart-header">
                    <div class="chart-title">Portfolio Value (USD Reference)</div>
                    <div style="font-size: 12px; color: #ff6b6b; font-weight: 500;">
                        ‚ö†Ô∏è Includes market fluctuations - NOT trading system performance
                    </div>
                </div>
                <div style="position: relative; height: 200px; width: 100%;">
                    <canvas id="dollarChart"></canvas>
                </div>
            </div>

            <!-- ETH/BTC Ratio History Chart -->
            <div class="chart-container" style="margin-bottom: 32px;">
                <div class="chart-header">
                    <div class="chart-title">ETH/BTC Ratio History</div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="font-size: 12px; color: #b3b3b3; font-weight: 500;">
                            üìä Historical ratio movements - Shows market opportunities
                        </div>
                        <button onclick="refreshHistoricalData()" style="background: #2d2d30; border: 1px solid #404040; color: #b3b3b3; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer;">
                            üîÑ Refresh
                        </button>
                    </div>
                </div>
                <div style="position: relative; height: 250px; width: 100%;">
                    <canvas id="ratioChart"></canvas>
                </div>
            </div>

            <!-- Z-Score History Chart -->
            <div class="chart-container" style="margin-bottom: 32px;">
                <div class="chart-header">
                    <div class="chart-title">Z-Score History</div>
                    <div style="font-size: 12px; color: #fbbf24; font-weight: 500;">
                        üéØ Trading signals: >+1.26 = Sell ETH, <-1.26 = Buy ETH
                    </div>
                </div>
                <div style="position: relative; height: 250px; width: 100%;">
                    <canvas id="zscoreChart"></canvas>
                </div>
            </div>

            <div class="trading-signal">
                <div class="signal-header">Trading Signal</div>
                <div class="signal-status">
                    <div class="signal-action signal-hold" id="signal-action">HOLD</div>
                </div>
                
                <div class="metric-row">
                    <span class="metric-label">Z-Score</span>
                    <span class="metric-value" id="z-score">0.0000</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Strength</span>
                    <span class="metric-value" id="signal-strength">0.00%</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Confidence</span>
                    <span class="metric-value" id="signal-confidence">0.00%</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Threshold</span>
                    <span class="metric-value" id="threshold">¬±1.258</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Rebalance</span>
                    <span class="metric-value" id="rebalance-amount">49.79%</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Data Points</span>
                    <span class="metric-value" id="data-points">--</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Source</span>
                    <span class="metric-value" id="data-source">--</span>
                </div>
            </div>
        </div>

        <!-- Recent Activity & System Info -->
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 32px;">
            <!-- Recent Trades Section -->
            <div class="trades-section">
                <div class="trades-header">
                    <div class="trades-title">Recent Activity</div>
                </div>
                <div class="table-container">
                    <table class="trades-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Type</th>
                                <th>Asset</th>
                                <th>Amount</th>
                                <th>Price</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="trades-table-body">
                            <tr>
                                <td colspan="6" style="text-align: center; color: #b3b3b3; padding: 20px;">
                                    No recent trades
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- System Performance -->
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">System Performance</div>
                </div>
                <div style="padding: 20px 0;">
                    <div class="metric-row">
                        <span class="metric-label">Strategy</span>
                        <span class="metric-value">Mega-Optimal</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Optimization</span>
                        <span class="metric-value">250 Iterations</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Crypto Return</span>
                        <span class="metric-value" style="color: #00d4aa;">+15.45%</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Win Rate</span>
                        <span class="metric-value" style="color: #00d4aa;">72%</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Max Drawdown</span>
                        <span class="metric-value">8.3%</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Transaction Cost</span>
                        <span class="metric-value">1.66%</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Uptime</span>
                        <span class="metric-value" style="color: #00d4aa;" id="system-uptime">24/7</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Strategy Details -->
        <div class="chart-container" style="margin-bottom: 32px;">
            <div class="chart-header">
                <div class="chart-title">Strategy Information</div>
            </div>
            <div style="padding: 20px; line-height: 1.6; color: #b3b3b3;">
                <p style="margin-bottom: 16px;">
                    <strong style="color: #ffffff;">PowerHODL</strong> uses an AI-optimized mean reversion strategy to <strong style="color: #fbbf24;">accumulate more BTC over time</strong>. 
                    Success is measured by BTC balance growth, not dollar profits. The system monitors the ETH/BTC ratio 24/7 and trades when opportunities arise.
                </p>
                <p style="margin-bottom: 16px;">
                    <strong style="color: #ffffff;">How it works:</strong> When ETH becomes statistically expensive vs BTC (Z-score > +1.258), 
                    the system sells ETH for BTC. When ETH becomes cheap vs BTC (Z-score < -1.258), it buys ETH with BTC. 
                    This exploits the natural mean reversion patterns in the ETH/BTC ratio.
                </p>
                <p>
                    <strong style="color: #ffffff;">Optimization:</strong> All parameters were discovered through 250+ iterations 
                    of advanced optimization techniques including genetic algorithms and simulated annealing, 
                    tested on years of historical data.
                </p>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let balanceChart = null;
        let dollarChart = null;
        let ratioChart = null;
        let zscoreChart = null;
        let isLoading = false;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeChart();
            initializeDollarChart();
            initializeRatioChart();
            initializeZScoreChart();
            loadDashboardData();
            
            // Set up auto-refresh every 30 seconds
            setInterval(loadDashboardData, 30000);
        });

        function initializeChart() {
            const ctx = document.getElementById('balanceChart').getContext('2d');
            
            balanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Portfolio Value',
                        data: [],
                        borderColor: '#00d4aa',
                        backgroundColor: 'rgba(0, 212, 170, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 0 // Disable animations to prevent resizing issues
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: {
                                color: '#2d2d30'
                            },
                            ticks: {
                                color: '#b3b3b3'
                            }
                        },
                        y: {
                            display: true,
                            grid: {
                                color: '#2d2d30'
                            },
                            ticks: {
                                color: '#b3b3b3',
                                callback: function(value) {
                                    return value.toFixed(8) + ' BTC';
                                }
                            }
                        }
                    }
                }
            });
        }

        function initializeDollarChart() {
            const ctx = document.getElementById('dollarChart').getContext('2d');
            
            dollarChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Portfolio Value (USD)',
                        data: [],
                        borderColor: '#ff6b6b',
                        backgroundColor: 'rgba(255, 107, 107, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 0 // Disable animations to prevent resizing issues
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: {
                                color: '#2d2d30'
                            },
                            ticks: {
                                color: '#b3b3b3'
                            }
                        },
                        y: {
                            display: true,
                            grid: {
                                color: '#2d2d30'
                            },
                            ticks: {
                                color: '#b3b3b3',
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function initializeRatioChart() {
            const ctx = document.getElementById('ratioChart').getContext('2d');
            
            ratioChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'ETH/BTC Ratio',
                        data: [],
                        borderColor: '#00d4aa',
                        backgroundColor: 'rgba(0, 212, 170, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1,
                        pointRadius: 1,
                        pointHoverRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 0 },
                    plugins: { legend: { display: false } },
                    scales: {
                        x: {
                            display: true,
                            grid: { color: '#2d2d30' },
                            ticks: { color: '#b3b3b3', maxTicksLimit: 6 }
                        },
                        y: {
                            display: true,
                            grid: { color: '#2d2d30' },
                            ticks: {
                                color: '#b3b3b3',
                                callback: function(value) {
                                    return value.toFixed(4);
                                }
                            }
                        }
                    }
                }
            });
        }

        function initializeZScoreChart() {
            const ctx = document.getElementById('zscoreChart').getContext('2d');
            
            zscoreChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Z-Score',
                        data: [],
                        borderColor: '#fbbf24',
                        backgroundColor: 'rgba(251, 191, 36, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1,
                        pointRadius: 1,
                        pointHoverRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 0 },
                    plugins: { 
                        legend: { display: false },
                        annotation: {
                            annotations: {
                                sellLine: {
                                    type: 'line',
                                    yMin: 1.257672,
                                    yMax: 1.257672,
                                    borderColor: '#ff6b6b',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    label: {
                                        content: 'Sell Threshold (+1.26)',
                                        enabled: true,
                                        position: 'end'
                                    }
                                },
                                buyLine: {
                                    type: 'line',
                                    yMin: -1.257672,
                                    yMax: -1.257672,
                                    borderColor: '#00d4aa',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    label: {
                                        content: 'Buy Threshold (-1.26)',
                                        enabled: true,
                                        position: 'end'
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: { color: '#2d2d30' },
                            ticks: { color: '#b3b3b3', maxTicksLimit: 6 }
                        },
                        y: {
                            display: true,
                            grid: { color: '#2d2d30' },
                            ticks: {
                                color: '#b3b3b3',
                                callback: function(value) {
                                    return value.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }

        async function loadDashboardData() {
            if (isLoading) return;
            
            try {
                isLoading = true;
                
                // Try to load real API data, fall back to mock data for local testing
                let signalData, portfolioData;
                
                try {
                    const signalResponse = await fetch('/api/signal');
                    const portfolioResponse = await fetch('/api/portfolio');
                    
                    if (signalResponse.ok && portfolioResponse.ok) {
                        signalData = await signalResponse.json();
                        portfolioData = await portfolioResponse.json();
                    } else {
                        throw new Error('API not available');
                    }
                } catch (apiError) {
                    console.log('Using mock data for local testing');
                    // Mock data for local testing
                    signalData = {
                        signal: { action: 'HOLD', zScore: -0.7411, strength: 0.741, confidence: 0.589 },
                        currentMarket: { ethBtcRatio: 0.037106, ethPrice: 4192, btcPrice: 112976 },
                        strategy: { zScoreThreshold: 1.257672 },
                        metadata: { dataPoints: 30, dataSource: 'mock' }
                    };
                    portfolioData = {
                        portfolio: {
                            btcAmount: "0.05432000",
                            ethAmount: "1.23456000", 
                            totalValueBTC: (0.10 + Math.random() * 0.01).toFixed(8), // Total BTC equivalent
                            allocation: {
                                btcPercent: "54.3%",
                                ethPercent: "45.7%"
                            }
                        }
                    };
                }
                
                updateSignalDisplay(signalData);
                updatePortfolioDisplay(portfolioData);
                updateChartData(portfolioData);
                updateDollarChartData(portfolioData, signalData);
                
                // Load historical data for ratio and Z-score charts (less frequently)
                if (!window.historicalDataLoaded) {
                    loadHistoricalCharts();
                    window.historicalDataLoaded = true;
                }
                
                updateLastUpdate();
                updateConnectionStatus(true);
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                updateConnectionStatus(false);
            } finally {
                isLoading = false;
            }
        }

        function updateSignalDisplay(data) {
            const actionElement = document.getElementById('signal-action');
            const action = data.signal?.action || 'HOLD';
            
            actionElement.textContent = action;
            actionElement.className = `signal-action signal-${action.toLowerCase().replace('_', '-')}`;
            
            document.getElementById('z-score').textContent = 
                data.signal?.zScore?.toFixed(4) || '0.0000';
            document.getElementById('signal-strength').textContent = 
                ((data.signal?.strength || 0) * 100).toFixed(1) + '%';
            document.getElementById('signal-confidence').textContent = 
                ((data.signal?.confidence || 0) * 100).toFixed(1) + '%';
            document.getElementById('data-points').textContent = 
                data.metadata?.dataPoints || '--';
            document.getElementById('data-source').textContent = 
                data.metadata?.dataSource || '--';
            
            // Update ETH/BTC ratio
            if (data.currentMarket) {
                document.getElementById('eth-btc-ratio').textContent = 
                    data.currentMarket.ethBtcRatio?.toFixed(6) || '0.000000';
                
                if (data.currentMarket.dataAge) {
                    const ageMinutes = Math.floor(data.currentMarket.dataAge / (1000 * 60));
                    document.getElementById('ratio-age').textContent = 
                        `${ageMinutes}m ago`;
                }
            }
        }

        function updatePortfolioDisplay(data) {
            if (data.portfolio) {
                const portfolio = data.portfolio;
                
                // Calculate total BTC equivalent (the CORE metric for PowerHODL)
                const btcBalance = parseFloat(portfolio.btcAmount) || 0;
                const ethBalance = parseFloat(portfolio.ethAmount) || 0;
                
                // Convert ETH to BTC equivalent using current market data
                let ethToBtcRatio = 0.04; // Default fallback
                if (window.latestMarketData && window.latestMarketData.ethPrice && window.latestMarketData.btcPrice) {
                    ethToBtcRatio = window.latestMarketData.ethPrice / window.latestMarketData.btcPrice;
                }
                
                // Use API's calculated total BTC value (more accurate)
                const totalBtcEquivalent = parseFloat(portfolio.totalValueBTC) || (btcBalance + (ethBalance * ethToBtcRatio));
                
                // Update main balance display - TOTAL BTC ACCUMULATED
                document.getElementById('total-balance').textContent = 
                    `${totalBtcEquivalent.toFixed(8)} BTC`;
                
                // Update individual asset balances (show actual amounts, not dollar values)
                document.getElementById('btc-balance').textContent = 
                    `${btcBalance.toFixed(8)} BTC`;
                document.getElementById('eth-balance').textContent = 
                    `${ethBalance.toFixed(8)} ETH`;
                
                // Store for chart updates
                window.currentTotalBTC = totalBtcEquivalent;
            }
        }

        function updateChartData(portfolioData) {
            if (!balanceChart || !portfolioData.portfolio) {
                console.log('Chart or portfolio data not available');
                return;
            }
            
            const now = new Date();
            const timeLabel = now.toLocaleTimeString();
            const totalBTC = window.currentTotalBTC || 0.1; // Use current BTC total
            
            // Limit chart to last 10 data points to prevent infinite growth
            const maxDataPoints = 10;
            
            console.log('Adding BTC chart data point:', timeLabel, totalBTC);
            
            // Clear data if we're at the limit to prevent accumulation
            if (balanceChart.data.labels.length >= maxDataPoints) {
                // Remove the oldest data point
                balanceChart.data.labels.shift();
                balanceChart.data.datasets[0].data.shift();
            }
            
            // Add new data point
            balanceChart.data.labels.push(timeLabel);
            balanceChart.data.datasets[0].data.push(totalBTC);
            
            console.log('Chart now has', balanceChart.data.labels.length, 'data points');
            
            // Update the chart without animation to prevent resizing
            balanceChart.update('none');
        }

        function updateDollarChartData(portfolioData, signalData) {
            if (!dollarChart || !portfolioData.portfolio) {
                console.log('Dollar chart or portfolio data not available');
                return;
            }
            
            const now = new Date();
            const timeLabel = now.toLocaleTimeString();
            
            // Calculate dollar value (includes market fluctuations)
            const btcBalance = parseFloat(portfolioData.portfolio.btcAmount) || 0;
            const ethBalance = parseFloat(portfolioData.portfolio.ethAmount) || 0;
            
            // Use current market prices if available
            let btcPrice = 43000; // Default fallback
            let ethPrice = 2200;   // Default fallback
            
            if (signalData && signalData.currentMarket) {
                btcPrice = signalData.currentMarket.btcPrice || btcPrice;
                ethPrice = signalData.currentMarket.ethPrice || ethPrice;
            }
            
            const totalDollarValue = (btcBalance * btcPrice) + (ethBalance * ethPrice);
            
            // Limit chart to last 10 data points to prevent infinite growth
            const maxDataPoints = 10;
            
            console.log('Adding dollar chart data point:', timeLabel, '$' + totalDollarValue.toLocaleString());
            
            // Clear data if we're at the limit to prevent accumulation
            if (dollarChart.data.labels.length >= maxDataPoints) {
                // Remove the oldest data point
                dollarChart.data.labels.shift();
                dollarChart.data.datasets[0].data.shift();
            }
            
            // Add new data point
            dollarChart.data.labels.push(timeLabel);
            dollarChart.data.datasets[0].data.push(totalDollarValue);
            
            // Update chart
            dollarChart.update('none');
        }

        async function loadHistoricalCharts() {
            try {
                console.log('üìä Loading historical data for charts...');
                
                const response = await fetch('/api/historical?days=30');
                let historicalData;
                
                if (response.ok) {
                    const data = await response.json();
                    historicalData = data.data || [];
                    console.log(`‚úÖ Loaded ${historicalData.length} historical data points`);
                    
                    // Update data age display if available
                    if (data.metadata?.dataAgeMinutes) {
                        document.getElementById('ratio-age').textContent = 
                            `${data.metadata.dataAgeMinutes}m ago`;
                    }
                } else {
                    throw new Error('Historical API not available');
                }
                
                if (historicalData.length === 0) {
                    // Generate mock historical data for demo
                    console.log('üìä Generating mock historical data...');
                    historicalData = generateMockHistoricalData();
                }
                
                // Update charts with historical data
                updateHistoricalCharts(historicalData);
                
            } catch (error) {
                console.log('‚ö†Ô∏è Historical data unavailable, using mock data');
                const mockData = generateMockHistoricalData();
                updateHistoricalCharts(mockData);
            }
        }

        function generateMockHistoricalData() {
            const data = [];
            const baseRatio = 0.037;
            const today = new Date();
            
            for (let i = 29; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                
                // Generate realistic ratio fluctuation
                const volatility = 0.003;
                const trendComponent = Math.sin(i * 0.2) * 0.002;
                const randomComponent = (Math.random() - 0.5) * volatility;
                const ratio = baseRatio + trendComponent + randomComponent;
                
                // Generate Z-score based on ratio deviation
                const meanRatio = 0.037;
                const stdDev = 0.003;
                const zScore = (ratio - meanRatio) / stdDev;
                
                data.push({
                    date: date.toISOString().split('T')[0],
                    ethBtcRatio: ratio,
                    zScore: zScore,
                    ethPrice: 2200 + (Math.random() - 0.5) * 400,
                    btcPrice: 43000 + (Math.random() - 0.5) * 5000
                });
            }
            
            return data;
        }

        function updateHistoricalCharts(historicalData) {
            if (!historicalData || historicalData.length === 0) return;
            
            // Prepare data for charts (last 30 points to prevent overcrowding)
            const chartData = historicalData.slice(-30);
            const labels = chartData.map(d => {
                const date = new Date(d.date || d.timestamp);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            
            // Update ratio chart
            if (ratioChart) {
                ratioChart.data.labels = labels;
                ratioChart.data.datasets[0].data = chartData.map(d => d.ethBtcRatio);
                ratioChart.update('none');
                console.log('üìä Updated ratio chart with', chartData.length, 'points');
            }
            
            // Update Z-score chart
            if (zscoreChart) {
                zscoreChart.data.labels = labels;
                zscoreChart.data.datasets[0].data = chartData.map(d => d.zScore);
                zscoreChart.update('none');
                console.log('üìä Updated Z-score chart with', chartData.length, 'points');
            }
        }

        function updateLastUpdate() {
            const now = new Date();
            document.getElementById('last-update').textContent = 
                now.toLocaleTimeString();
        }

        function updateConnectionStatus(connected = true) {
            const statusElement = document.getElementById('connection-status');
            const dotElement = document.querySelector('.status-dot');
            
            if (connected) {
                statusElement.textContent = 'Connected';
                dotElement.style.background = '#00d4aa';
            } else {
                statusElement.textContent = 'Disconnected';
                dotElement.style.background = '#ff6b6b';
            }
        }

        function refreshData() {
            loadDashboardData();
        }

        function refreshHistoricalData() {
            console.log('üîÑ Manually refreshing historical data...');
            window.historicalDataLoaded = false;
            loadHistoricalCharts();
        }

        // Timeframe selector
        document.querySelectorAll('.timeframe-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.timeframe-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                // TODO: Update chart based on timeframe
                console.log('Timeframe selected:', this.textContent);
            });
        });
    </script>
</body>
</html>