<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PowerHODL - ETH/BTC Trading System</title>
    
    <!-- Chart.js for professional charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #0a0a0b;
            color: #ffffff;
            overflow-x: auto;
        }

        .header {
            background: #1a1a1b;
            border-bottom: 1px solid #2d2d30;
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .logo {
            font-weight: 600;
            font-size: 18px;
            color: #00d4aa;
        }

        .nav-item {
            color: #b3b3b3;
            font-size: 14px;
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .nav-item.active {
            background: #2d2d30;
            color: #ffffff;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
            color: #b3b3b3;
            font-size: 14px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #00d4aa;
        }

        .main-container {
            padding: 24px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .balance-section {
            margin-bottom: 32px;
        }

        .balance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .balance-title {
            font-size: 14px;
            color: #b3b3b3;
            font-weight: 400;
        }

        .total-balance {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .balance-change {
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .positive {
            color: #00d4aa;
        }

        .negative {
            color: #ff6b6b;
        }

        .assets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .asset-card {
            background: #1a1a1b;
            border: 1px solid #2d2d30;
            border-radius: 8px;
            padding: 20px;
        }

        .asset-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .asset-name {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .asset-symbol {
            font-size: 14px;
            color: #b3b3b3;
        }

        .asset-balance {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .asset-value {
            font-size: 14px;
            color: #b3b3b3;
        }

        .asset-change {
            font-size: 14px;
            font-weight: 500;
        }

        .charts-section {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
            margin-bottom: 32px;
        }

        .chart-container {
            background: #1a1a1b;
            border: 1px solid #2d2d30;
            border-radius: 8px;
            padding: 20px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 500;
        }

        .timeframe-selector {
            display: flex;
            gap: 4px;
        }

        .timeframe-btn {
            background: none;
            border: none;
            color: #b3b3b3;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .timeframe-btn.active {
            background: #00d4aa;
            color: #000;
        }

        .trading-signal {
            background: #1a1a1b;
            border: 1px solid #2d2d30;
            border-radius: 8px;
            padding: 20px;
        }

        .signal-header {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 16px;
        }

        .signal-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
        }

        .signal-action {
            font-size: 18px;
            font-weight: 600;
            padding: 8px 16px;
            border-radius: 6px;
            background: #2d2d30;
        }

        .signal-hold {
            color: #fbbf24;
        }

        .signal-buy {
            color: #00d4aa;
        }

        .signal-sell {
            color: #ff6b6b;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .metric-label {
            color: #b3b3b3;
        }

        .metric-value {
            font-weight: 500;
        }

        .trades-section {
            background: #1a1a1b;
            border: 1px solid #2d2d30;
            border-radius: 8px;
            padding: 20px;
        }

        .trades-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .trades-title {
            font-size: 16px;
            font-weight: 500;
        }

        .table-container {
            overflow-x: auto;
        }

        .trades-table {
            width: 100%;
            border-collapse: collapse;
        }

        .trades-table th,
        .trades-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #2d2d30;
            font-size: 14px;
        }

        .trades-table th {
            color: #b3b3b3;
            font-weight: 500;
            background: #131314;
        }

        .trades-table td {
            color: #ffffff;
        }

        .refresh-btn {
            background: #00d4aa;
            color: #000;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .refresh-btn:hover {
            background: #00b894;
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        @media (max-width: 768px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
            
            .assets-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <div class="logo">PowerHODL</div>
            <span class="nav-item active">Live Trading Dashboard</span>
            <div style="font-size: 12px; color: #fbbf24; margin-top: 4px; font-weight: 500;">
                üéØ Mission: Accumulate BTC through ETH/BTC ratio trading
            </div>
        </div>
        <div class="header-right">
            <div class="status-indicator">
                <div class="status-dot"></div>
                <span id="connection-status">Connected</span>
            </div>
            <span id="last-update">--</span>
        </div>
    </header>

    <div class="main-container">
        <!-- Balance Section -->
        <div class="balance-section">
            <div class="balance-header">
                <div class="balance-title">Total BTC Accumulated</div>
                <div style="display: flex; gap: 10px;">
                    <button class="refresh-btn" onclick="refreshData()">Refresh</button>
                    <button class="sandbox-btn" onclick="openBacktestSandbox()" style="background: #fbbf24; color: #000; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 500; cursor: pointer;">Backtest Sandbox</button>
                </div>
            </div>
            <div class="total-balance" id="total-balance">0.00000000 BTC</div>
            <div class="balance-change" id="balance-change">
                <span id="btc-change-amount">+0.00000000 BTC</span>
                <span id="btc-change-percent">+0.00%</span>
            </div>
        </div>

        <!-- Assets Grid -->
        <div class="assets-grid">
            <div class="asset-card">
                <div class="asset-header">
                    <div class="asset-name">
                        <span>Bitcoin</span>
                        <span class="asset-symbol">BTC</span>
                    </div>
                </div>
                <div class="asset-balance" id="btc-balance">0.00000 BTC</div>
                <div class="asset-value" id="btc-value">Direct Holdings</div>
                <div class="asset-change positive" id="btc-change">+0.00%</div>
            </div>

            <div class="asset-card">
                <div class="asset-header">
                    <div class="asset-name">
                        <span>Ethereum</span>
                        <span class="asset-symbol">ETH</span>
                    </div>
                </div>
                <div class="asset-balance" id="eth-balance">0.00000 ETH</div>
                <div class="asset-value" id="eth-value">ETH Holdings</div>
                <div class="asset-change positive" id="eth-change">+0.00%</div>
            </div>

            <div class="asset-card">
                <div class="asset-header">
                    <div class="asset-name">
                        <span>ETH/BTC Ratio</span>
                        <span class="asset-symbol">CURRENT</span>
                    </div>
                </div>
                <div class="asset-balance" id="eth-btc-ratio">0.000000</div>
                <div class="asset-value" id="ratio-age">--</div>
                <div class="asset-change" id="ratio-change">--</div>
            </div>
        </div>

        <!-- Charts and Signal Section -->
        <div class="charts-section">
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">BTC Accumulation Over Time</div>
                    <div class="timeframe-selector">
                        <button class="timeframe-btn active">1D</button>
                        <button class="timeframe-btn">7D</button>
                        <button class="timeframe-btn">1M</button>
                        <button class="timeframe-btn">3M</button>
                        <button class="timeframe-btn">1Y</button>
                    </div>
                </div>
                <div style="position: relative; height: 300px; width: 100%;">
                    <canvas id="balanceChart"></canvas>
                </div>
            </div>

            <!-- Secondary Dollar Value Chart (Reference Only) -->
            <div class="chart-container" style="margin-bottom: 32px;">
                <div class="chart-header">
                    <div class="chart-title">Portfolio Value (USD Reference)</div>
                    <div style="font-size: 12px; color: #ff6b6b; font-weight: 500;">
                        ‚ö†Ô∏è Includes market fluctuations - NOT trading system performance
                    </div>
                </div>
                <div style="position: relative; height: 200px; width: 100%;">
                    <canvas id="dollarChart"></canvas>
                </div>
            </div>

            <!-- ETH/BTC Ratio History Chart -->
            <div class="chart-container" style="margin-bottom: 32px;">
                <div class="chart-header">
                    <div class="chart-title">ETH/BTC Ratio History</div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="font-size: 12px; color: #b3b3b3; font-weight: 500;">
                            üìä Historical ratio movements - Shows market opportunities
                        </div>
                        <button onclick="refreshHistoricalData()" style="background: #2d2d30; border: 1px solid #404040; color: #b3b3b3; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer;">
                            üîÑ Refresh
                        </button>
                    </div>
                </div>
                <div style="position: relative; height: 250px; width: 100%;">
                    <canvas id="ratioChart"></canvas>
                </div>
            </div>

            <!-- Z-Score History Chart -->
            <div class="chart-container" style="margin-bottom: 32px;">
                <div class="chart-header">
                    <div class="chart-title">Z-Score History</div>
                    <div style="font-size: 12px; color: #fbbf24; font-weight: 500;">
                        üéØ Trading signals: >+1.26 = Sell ETH, <-1.26 = Buy ETH
                    </div>
                </div>
                <div style="position: relative; height: 250px; width: 100%;">
                    <canvas id="zscoreChart"></canvas>
                </div>
            </div>

            <div class="trading-signal">
                <div class="signal-header">Trading Signal</div>
                <div class="signal-status">
                    <div class="signal-action signal-hold" id="signal-action">HOLD</div>
                </div>
                
                <div class="metric-row">
                    <span class="metric-label">Z-Score</span>
                    <span class="metric-value" id="z-score">0.0000</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Strength</span>
                    <span class="metric-value" id="signal-strength">0.00%</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Confidence</span>
                    <span class="metric-value" id="signal-confidence">0.00%</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Threshold</span>
                    <span class="metric-value" id="threshold">¬±1.258</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Rebalance</span>
                    <span class="metric-value" id="rebalance-amount">49.79%</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Data Points</span>
                    <span class="metric-value" id="data-points">--</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Source</span>
                    <span class="metric-value" id="data-source">--</span>
                </div>
            </div>
        </div>

        <!-- Recent Activity & System Info -->
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 32px;">
            <!-- Recent Trades Section -->
            <div class="trades-section">
                <div class="trades-header">
                    <div class="trades-title">Recent Activity</div>
                </div>
                <div class="table-container">
                    <table class="trades-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Type</th>
                                <th>Asset</th>
                                <th>Amount</th>
                                <th>Price</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="trades-table-body">
                            <tr>
                                <td colspan="6" style="text-align: center; color: #b3b3b3; padding: 20px;">
                                    No recent trades
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- System Performance -->
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">System Performance</div>
                </div>
                <div style="padding: 20px 0;">
                    <div class="metric-row">
                        <span class="metric-label">Strategy</span>
                        <span class="metric-value">Mega-Optimal</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Optimization</span>
                        <span class="metric-value">250 Iterations</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Crypto Return</span>
                        <span class="metric-value" style="color: #00d4aa;">+15.45%</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Win Rate</span>
                        <span class="metric-value" style="color: #00d4aa;">72%</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Max Drawdown</span>
                        <span class="metric-value">8.3%</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Transaction Cost</span>
                        <span class="metric-value">1.66%</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Uptime</span>
                        <span class="metric-value" style="color: #00d4aa;" id="system-uptime">24/7</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Strategy Details -->
        <div class="chart-container" style="margin-bottom: 32px;">
            <div class="chart-header">
                <div class="chart-title">Strategy Information</div>
            </div>
            <div style="padding: 20px; line-height: 1.6; color: #b3b3b3;">
                <p style="margin-bottom: 16px;">
                    <strong style="color: #ffffff;">PowerHODL</strong> uses an AI-optimized mean reversion strategy to <strong style="color: #fbbf24;">accumulate more BTC over time</strong>. 
                    Success is measured by BTC balance growth, not dollar profits. The system monitors the ETH/BTC ratio 24/7 and trades when opportunities arise.
                </p>
                <p style="margin-bottom: 16px;">
                    <strong style="color: #ffffff;">How it works:</strong> When ETH becomes statistically expensive vs BTC (Z-score > +1.258), 
                    the system sells ETH for BTC. When ETH becomes cheap vs BTC (Z-score < -1.258), it buys ETH with BTC. 
                    This exploits the natural mean reversion patterns in the ETH/BTC ratio.
                </p>
                <p>
                    <strong style="color: #ffffff;">Optimization:</strong> All parameters were discovered through 250+ iterations 
                    of advanced optimization techniques including genetic algorithms and simulated annealing, 
                    tested on years of historical data.
                </p>
            </div>
        </div>
    </div>

    <!-- Backtest Sandbox Modal -->
    <div id="backtestSandbox" class="sandbox-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; overflow-y: auto;">
        <div class="sandbox-content" style="background: #1a1a1b; margin: 20px auto; max-width: 1200px; border-radius: 12px; border: 1px solid #2d2d30; position: relative;">
            <div class="sandbox-header" style="padding: 20px; border-bottom: 1px solid #2d2d30; display: flex; justify-content: between; align-items: center;">
                <h2 style="color: #ffffff; margin: 0; font-size: 24px;">Backtest Sandbox</h2>
                <button onclick="closeBacktestSandbox()" style="background: #ff6b6b; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 16px;">‚úï</button>
            </div>
            
            <div class="sandbox-body" style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px; padding: 20px;">
                <!-- Parameter Controls -->
                <div class="parameter-panel" style="background: #252526; padding: 20px; border-radius: 8px; border: 1px solid #2d2d30;">
                    <h3 style="color: #ffffff; margin-top: 0;">Strategy Parameters</h3>
                    
                    <!-- Z-Score Threshold -->
                    <div class="param-group" style="margin-bottom: 20px;">
                        <label style="color: #b3b3b3; display: block; margin-bottom: 5px;">Z-Score Threshold:</label>
                        <input type="range" id="zScoreThreshold" min="0.5" max="3.0" step="0.1" value="1.258" style="width: 100%; margin-bottom: 5px;">
                        <span id="zScoreValue" style="color: #fbbf24; font-weight: bold;">¬±1.258</span>
                        <p style="color: #666; font-size: 12px; margin: 5px 0 0 0;">Higher = fewer but stronger signals</p>
                    </div>

                    <!-- Rebalance Percentage -->
                    <div class="param-group" style="margin-bottom: 20px;">
                        <label style="color: #b3b3b3; display: block; margin-bottom: 5px;">Rebalance Percentage:</label>
                        <input type="range" id="rebalancePercent" min="10" max="90" step="5" value="50" style="width: 100%; margin-bottom: 5px;">
                        <span id="rebalanceValue" style="color: #fbbf24; font-weight: bold;">50%</span>
                        <p style="color: #666; font-size: 12px; margin: 5px 0 0 0;">Percentage of holdings to trade</p>
                    </div>

                    <!-- Lookback Window -->
                    <div class="param-group" style="margin-bottom: 20px;">
                        <label style="color: #b3b3b3; display: block; margin-bottom: 5px;">Lookback Window (days):</label>
                        <input type="range" id="lookbackWindow" min="5" max="60" step="1" value="15" style="width: 100%; margin-bottom: 5px;">
                        <span id="lookbackValue" style="color: #fbbf24; font-weight: bold;">15 days</span>
                        <p style="color: #666; font-size: 12px; margin: 5px 0 0 0;">Historical window for Z-score calculation</p>
                    </div>

                    <!-- Transaction Cost -->
                    <div class="param-group" style="margin-bottom: 20px;">
                        <label style="color: #b3b3b3; display: block; margin-bottom: 5px;">Transaction Cost (%):</label>
                        <input type="range" id="transactionCost" min="0" max="5" step="0.1" value="1.66" style="width: 100%; margin-bottom: 5px;">
                        <span id="transactionValue" style="color: #fbbf24; font-weight: bold;">1.66%</span>
                        <p style="color: #666; font-size: 12px; margin: 5px 0 0 0;">Exchange fees per trade</p>
                    </div>

                    <!-- Data Range -->
                    <div class="param-group" style="margin-bottom: 20px;">
                        <label style="color: #b3b3b3; display: block; margin-bottom: 5px;">Backtest Period:</label>
                        <select id="backtestPeriod" style="width: 100%; padding: 8px; background: #1a1a1b; color: #ffffff; border: 1px solid #2d2d30; border-radius: 4px;">
                            <option value="30">Last 30 days</option>
                            <option value="90">Last 90 days</option>
                            <option value="180">Last 180 days</option>
                            <option value="365" selected>Last 365 days</option>
                        </select>
                    </div>

                    <!-- Starting Balance -->
                    <div class="param-group" style="margin-bottom: 20px;">
                        <label style="color: #b3b3b3; display: block; margin-bottom: 5px;">Starting BTC:</label>
                        <input type="number" id="startingBTC" step="0.01" value="0.10" style="width: 100%; padding: 8px; background: #1a1a1b; color: #ffffff; border: 1px solid #2d2d30; border-radius: 4px;">
                        <label style="color: #b3b3b3; display: block; margin-top: 10px; margin-bottom: 5px;">Starting ETH:</label>
                        <input type="number" id="startingETH" step="0.1" value="2.0" style="width: 100%; padding: 8px; background: #1a1a1b; color: #ffffff; border: 1px solid #2d2d30; border-radius: 4px;">
                    </div>

                    <!-- Action Buttons -->
                    <div class="action-buttons" style="margin-top: 30px;">
                        <button onclick="runSingleBacktest()" style="width: 100%; padding: 12px; background: #00d4aa; color: #000; border: none; border-radius: 6px; font-weight: bold; margin-bottom: 10px; cursor: pointer;">Run Single Backtest</button>
                        <button onclick="runOptimization()" style="width: 100%; padding: 12px; background: #fbbf24; color: #000; border: none; border-radius: 6px; font-weight: bold; margin-bottom: 10px; cursor: pointer;">Run Optimization (10 iterations)</button>
                        <button onclick="runAdvancedOptimization()" style="width: 100%; padding: 12px; background: #ff6b6b; color: #fff; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">Advanced Optimization (100 iterations)</button>
                    </div>

                    <!-- Preset Strategies -->
                    <div class="preset-strategies" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #2d2d30;">
                        <h4 style="color: #ffffff; margin-bottom: 10px;">Preset Strategies:</h4>
                        <button onclick="loadPreset('conservative')" style="width: 100%; padding: 8px; background: #2d2d30; color: #b3b3b3; border: 1px solid #404040; border-radius: 4px; margin-bottom: 5px; cursor: pointer;">Conservative</button>
                        <button onclick="loadPreset('megaOptimal')" style="width: 100%; padding: 8px; background: #2d2d30; color: #b3b3b3; border: 1px solid #404040; border-radius: 4px; margin-bottom: 5px; cursor: pointer;">Mega-Optimal (Current)</button>
                        <button onclick="loadPreset('aggressive')" style="width: 100%; padding: 8px; background: #2d2d30; color: #b3b3b3; border: 1px solid #404040; border-radius: 4px; margin-bottom: 5px; cursor: pointer;">Aggressive</button>
                    </div>
                </div>

                <!-- Results Panel -->
                <div class="results-panel" style="background: #252526; padding: 20px; border-radius: 8px; border: 1px solid #2d2d30;">
                    <div class="results-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: #ffffff; margin: 0;">Backtest Results</h3>
                        <div id="backtestStatus" style="color: #b3b3b3; font-size: 14px;">Ready to run</div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="quick-stats" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div class="stat-card" style="background: #1a1a1b; padding: 15px; border-radius: 6px; border: 1px solid #2d2d30;">
                            <div style="color: #b3b3b3; font-size: 12px; margin-bottom: 5px;">BTC GROWTH</div>
                            <div id="btcGrowth" style="color: #00d4aa; font-size: 20px; font-weight: bold;">--</div>
                        </div>
                        <div class="stat-card" style="background: #1a1a1b; padding: 15px; border-radius: 6px; border: 1px solid #2d2d30;">
                            <div style="color: #b3b3b3; font-size: 12px; margin-bottom: 5px;">WIN RATE</div>
                            <div id="winRate" style="color: #fbbf24; font-size: 20px; font-weight: bold;">--</div>
                        </div>
                        <div class="stat-card" style="background: #1a1a1b; padding: 15px; border-radius: 6px; border: 1px solid #2d2d30;">
                            <div style="color: #b3b3b3; font-size: 12px; margin-bottom: 5px;">TOTAL TRADES</div>
                            <div id="totalTrades" style="color: #ffffff; font-size: 20px; font-weight: bold;">--</div>
                        </div>
                        <div class="stat-card" style="background: #1a1a1b; padding: 15px; border-radius: 6px; border: 1px solid #2d2d30;">
                            <div style="color: #b3b3b3; font-size: 12px; margin-bottom: 5px;">MAX DRAWDOWN</div>
                            <div id="maxDrawdown" style="color: #ff6b6b; font-size: 20px; font-weight: bold;">--</div>
                        </div>
                    </div>

                    <!-- Performance Chart -->
                    <div class="chart-section" style="margin-bottom: 20px;">
                        <h4 style="color: #ffffff; margin-bottom: 10px;">BTC Accumulation Over Time</h4>
                        <div style="position: relative; height: 250px; width: 100%; background: #1a1a1b; border-radius: 6px; border: 1px solid #2d2d30;">
                            <canvas id="backtestChart"></canvas>
                        </div>
                    </div>

                    <!-- Trade Log -->
                    <div class="trade-log" style="max-height: 200px; overflow-y: auto;">
                        <h4 style="color: #ffffff; margin-bottom: 10px;">Recent Trades</h4>
                        <div id="tradeLogContent" style="background: #1a1a1b; border-radius: 6px; border: 1px solid #2d2d30; padding: 10px;">
                            <div style="color: #666; text-align: center; padding: 20px;">Run a backtest to see trade history</div>
                        </div>
                    </div>

                    <!-- Optimization Progress -->
                    <div id="optimizationProgress" style="display: none; margin-top: 20px;">
                        <h4 style="color: #ffffff; margin-bottom: 10px;">Optimization Progress</h4>
                        <div style="background: #1a1a1b; border-radius: 6px; border: 1px solid #2d2d30; padding: 15px;">
                            <div style="color: #b3b3b3; margin-bottom: 10px;">
                                Iteration <span id="currentIteration">0</span> of <span id="totalIterations">0</span>
                            </div>
                            <div style="background: #2d2d30; height: 8px; border-radius: 4px; overflow: hidden;">
                                <div id="progressBar" style="background: #00d4aa; height: 100%; width: 0%; transition: width 0.3s;"></div>
                            </div>
                            <div style="margin-top: 10px; color: #fbbf24;">
                                Best BTC Growth: <span id="bestBtcGrowth">--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let balanceChart = null;
        let dollarChart = null;
        let ratioChart = null;
        let zscoreChart = null;
        let isLoading = false;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeChart();
            initializeDollarChart();
            initializeRatioChart();
            initializeZScoreChart();
            loadDashboardData();
            
            // Set up auto-refresh every 30 seconds
            setInterval(loadDashboardData, 30000);
        });

        function initializeChart() {
            const ctx = document.getElementById('balanceChart').getContext('2d');
            
            balanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Portfolio Value',
                        data: [],
                        borderColor: '#00d4aa',
                        backgroundColor: 'rgba(0, 212, 170, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 0 // Disable animations to prevent resizing issues
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: {
                                color: '#2d2d30'
                            },
                            ticks: {
                                color: '#b3b3b3'
                            }
                        },
                        y: {
                            display: true,
                            grid: {
                                color: '#2d2d30'
                            },
                            ticks: {
                                color: '#b3b3b3',
                                callback: function(value) {
                                    return value.toFixed(8) + ' BTC';
                                }
                            }
                        }
                    }
                }
            });
        }

        function initializeDollarChart() {
            const ctx = document.getElementById('dollarChart').getContext('2d');
            
            dollarChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Portfolio Value (USD)',
                        data: [],
                        borderColor: '#ff6b6b',
                        backgroundColor: 'rgba(255, 107, 107, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 0 // Disable animations to prevent resizing issues
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: {
                                color: '#2d2d30'
                            },
                            ticks: {
                                color: '#b3b3b3'
                            }
                        },
                        y: {
                            display: true,
                            grid: {
                                color: '#2d2d30'
                            },
                            ticks: {
                                color: '#b3b3b3',
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function initializeRatioChart() {
            const ctx = document.getElementById('ratioChart').getContext('2d');
            
            ratioChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'ETH/BTC Ratio',
                        data: [],
                        borderColor: '#00d4aa',
                        backgroundColor: 'rgba(0, 212, 170, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1,
                        pointRadius: 1,
                        pointHoverRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 0 },
                    plugins: { legend: { display: false } },
                    scales: {
                        x: {
                            display: true,
                            grid: { color: '#2d2d30' },
                            ticks: { color: '#b3b3b3', maxTicksLimit: 6 }
                        },
                        y: {
                            display: true,
                            grid: { color: '#2d2d30' },
                            ticks: {
                                color: '#b3b3b3',
                                callback: function(value) {
                                    return value.toFixed(4);
                                }
                            }
                        }
                    }
                }
            });
        }

        function initializeZScoreChart() {
            const ctx = document.getElementById('zscoreChart').getContext('2d');
            
            zscoreChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Z-Score',
                        data: [],
                        borderColor: '#fbbf24',
                        backgroundColor: 'rgba(251, 191, 36, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1,
                        pointRadius: 1,
                        pointHoverRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 0 },
                    plugins: { 
                        legend: { display: false },
                        annotation: {
                            annotations: {
                                sellLine: {
                                    type: 'line',
                                    yMin: 1.257672,
                                    yMax: 1.257672,
                                    borderColor: '#ff6b6b',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    label: {
                                        content: 'Sell Threshold (+1.26)',
                                        enabled: true,
                                        position: 'end'
                                    }
                                },
                                buyLine: {
                                    type: 'line',
                                    yMin: -1.257672,
                                    yMax: -1.257672,
                                    borderColor: '#00d4aa',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    label: {
                                        content: 'Buy Threshold (-1.26)',
                                        enabled: true,
                                        position: 'end'
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: { color: '#2d2d30' },
                            ticks: { color: '#b3b3b3', maxTicksLimit: 6 }
                        },
                        y: {
                            display: true,
                            grid: { color: '#2d2d30' },
                            ticks: {
                                color: '#b3b3b3',
                                callback: function(value) {
                                    return value.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }

        async function loadDashboardData() {
            if (isLoading) return;
            
            try {
                isLoading = true;
                
                // Try to load real API data, fall back to mock data for local testing
                let signalData, portfolioData;
                
                try {
                    const signalResponse = await fetch('/api/signal');
                    const portfolioResponse = await fetch('/api/portfolio');
                    
                    if (signalResponse.ok && portfolioResponse.ok) {
                        signalData = await signalResponse.json();
                        portfolioData = await portfolioResponse.json();
                    } else {
                        throw new Error('API not available');
                    }
                } catch (apiError) {
                    console.log('Using mock data for local testing');
                    // Mock data for local testing
                    signalData = {
                        signal: { action: 'HOLD', zScore: -0.7411, strength: 0.741, confidence: 0.589 },
                        currentMarket: { ethBtcRatio: 0.037106, ethPrice: 4192, btcPrice: 112976 },
                        strategy: { zScoreThreshold: 1.257672 },
                        metadata: { dataPoints: 30, dataSource: 'mock' }
                    };
                    portfolioData = {
                        portfolio: {
                            btcAmount: "0.05432000",
                            ethAmount: "1.23456000", 
                            totalValueBTC: (0.10 + Math.random() * 0.01).toFixed(8), // Total BTC equivalent
                            allocation: {
                                btcPercent: "54.3%",
                                ethPercent: "45.7%"
                            }
                        }
                    };
                }
                
                updateSignalDisplay(signalData);
                updatePortfolioDisplay(portfolioData);
                updateChartData(portfolioData);
                updateDollarChartData(portfolioData, signalData);
                
                // Load historical data for ratio and Z-score charts (less frequently)
                if (!window.historicalDataLoaded) {
                    loadHistoricalCharts();
                    window.historicalDataLoaded = true;
                }
                
                updateLastUpdate();
                updateConnectionStatus(true);
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                updateConnectionStatus(false);
            } finally {
                isLoading = false;
            }
        }

        function updateSignalDisplay(data) {
            const actionElement = document.getElementById('signal-action');
            const action = data.signal?.action || 'HOLD';
            
            actionElement.textContent = action;
            actionElement.className = `signal-action signal-${action.toLowerCase().replace('_', '-')}`;
            
            document.getElementById('z-score').textContent = 
                data.signal?.zScore?.toFixed(4) || '0.0000';
            document.getElementById('signal-strength').textContent = 
                ((data.signal?.strength || 0) * 100).toFixed(1) + '%';
            document.getElementById('signal-confidence').textContent = 
                ((data.signal?.confidence || 0) * 100).toFixed(1) + '%';
            document.getElementById('data-points').textContent = 
                data.metadata?.dataPoints || '--';
            document.getElementById('data-source').textContent = 
                data.metadata?.dataSource || '--';
            
            // Update ETH/BTC ratio
            if (data.currentMarket) {
                document.getElementById('eth-btc-ratio').textContent = 
                    data.currentMarket.ethBtcRatio?.toFixed(6) || '0.000000';
                
                if (data.currentMarket.dataAge) {
                    const ageMinutes = Math.floor(data.currentMarket.dataAge / (1000 * 60));
                    document.getElementById('ratio-age').textContent = 
                        `${ageMinutes}m ago`;
                }
            }
        }

        function updatePortfolioDisplay(data) {
            if (data.portfolio) {
                const portfolio = data.portfolio;
                
                // Calculate total BTC equivalent (the CORE metric for PowerHODL)
                const btcBalance = parseFloat(portfolio.btcAmount) || 0;
                const ethBalance = parseFloat(portfolio.ethAmount) || 0;
                
                // Convert ETH to BTC equivalent using current market data
                let ethToBtcRatio = 0.04; // Default fallback
                if (window.latestMarketData && window.latestMarketData.ethPrice && window.latestMarketData.btcPrice) {
                    ethToBtcRatio = window.latestMarketData.ethPrice / window.latestMarketData.btcPrice;
                }
                
                // Use API's calculated total BTC value (more accurate)
                const totalBtcEquivalent = parseFloat(portfolio.totalValueBTC) || (btcBalance + (ethBalance * ethToBtcRatio));
                
                // Update main balance display - TOTAL BTC ACCUMULATED
                document.getElementById('total-balance').textContent = 
                    `${totalBtcEquivalent.toFixed(8)} BTC`;
                
                // Update individual asset balances (show actual amounts, not dollar values)
                document.getElementById('btc-balance').textContent = 
                    `${btcBalance.toFixed(8)} BTC`;
                document.getElementById('eth-balance').textContent = 
                    `${ethBalance.toFixed(8)} ETH`;
                
                // Store for chart updates
                window.currentTotalBTC = totalBtcEquivalent;
            }
        }

        function updateChartData(portfolioData) {
            if (!balanceChart || !portfolioData.portfolio) {
                console.log('Chart or portfolio data not available');
                return;
            }
            
            const now = new Date();
            const timeLabel = now.toLocaleTimeString();
            const totalBTC = window.currentTotalBTC || 0.1; // Use current BTC total
            
            // Limit chart to last 10 data points to prevent infinite growth
            const maxDataPoints = 10;
            
            console.log('Adding BTC chart data point:', timeLabel, totalBTC);
            
            // Clear data if we're at the limit to prevent accumulation
            if (balanceChart.data.labels.length >= maxDataPoints) {
                // Remove the oldest data point
                balanceChart.data.labels.shift();
                balanceChart.data.datasets[0].data.shift();
            }
            
            // Add new data point
            balanceChart.data.labels.push(timeLabel);
            balanceChart.data.datasets[0].data.push(totalBTC);
            
            console.log('Chart now has', balanceChart.data.labels.length, 'data points');
            
            // Update the chart without animation to prevent resizing
            balanceChart.update('none');
        }

        function updateDollarChartData(portfolioData, signalData) {
            if (!dollarChart || !portfolioData.portfolio) {
                console.log('Dollar chart or portfolio data not available');
                return;
            }
            
            const now = new Date();
            const timeLabel = now.toLocaleTimeString();
            
            // Calculate dollar value (includes market fluctuations)
            const btcBalance = parseFloat(portfolioData.portfolio.btcAmount) || 0;
            const ethBalance = parseFloat(portfolioData.portfolio.ethAmount) || 0;
            
            // Use current market prices if available
            let btcPrice = 43000; // Default fallback
            let ethPrice = 2200;   // Default fallback
            
            if (signalData && signalData.currentMarket) {
                btcPrice = signalData.currentMarket.btcPrice || btcPrice;
                ethPrice = signalData.currentMarket.ethPrice || ethPrice;
            }
            
            const totalDollarValue = (btcBalance * btcPrice) + (ethBalance * ethPrice);
            
            // Limit chart to last 10 data points to prevent infinite growth
            const maxDataPoints = 10;
            
            console.log('Adding dollar chart data point:', timeLabel, '$' + totalDollarValue.toLocaleString());
            
            // Clear data if we're at the limit to prevent accumulation
            if (dollarChart.data.labels.length >= maxDataPoints) {
                // Remove the oldest data point
                dollarChart.data.labels.shift();
                dollarChart.data.datasets[0].data.shift();
            }
            
            // Add new data point
            dollarChart.data.labels.push(timeLabel);
            dollarChart.data.datasets[0].data.push(totalDollarValue);
            
            // Update chart
            dollarChart.update('none');
        }

        async function loadHistoricalCharts() {
            try {
                console.log('üìä Loading historical data for charts...');
                
                const response = await fetch('/api/historical?days=30');
                let historicalData;
                
                if (response.ok) {
                    const data = await response.json();
                    historicalData = data.data || [];
                    console.log(`‚úÖ Loaded ${historicalData.length} historical data points`);
                    
                    // Update data age display if available
                    if (data.metadata?.dataAgeMinutes) {
                        document.getElementById('ratio-age').textContent = 
                            `${data.metadata.dataAgeMinutes}m ago`;
                    }
                } else {
                    throw new Error('Historical API not available');
                }
                
                if (historicalData.length === 0) {
                    // Generate mock historical data for demo
                    console.log('üìä Generating CONSISTENT mock historical data (same every time)...');
                    historicalData = generateMockHistoricalData();
                    console.log('üé≠ Using mock data - charts will be consistent on refresh');
                } else {
                    console.log('üì° Using REAL historical data from database/API');
                }
                
                // Update charts with historical data
                updateHistoricalCharts(historicalData);
                
            } catch (error) {
                console.log('‚ö†Ô∏è Historical data unavailable, using mock data');
                const mockData = generateMockHistoricalData();
                updateHistoricalCharts(mockData);
            }
        }

        function generateMockHistoricalData() {
            const data = [];
            const baseRatio = 0.037;
            const today = new Date();
            
            for (let i = 29; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                
                // Generate CONSISTENT ratio fluctuation using deterministic seed
                const volatility = 0.003;
                const trendComponent = Math.sin(i * 0.2) * 0.002;
                // Use deterministic "random" based on day index for consistency
                const pseudoRandom = Math.sin(i * 12.9898) * 0.5; // Deterministic value between -0.5 and 0.5
                const ratio = baseRatio + trendComponent + (pseudoRandom * volatility);
                
                // Generate Z-score based on ratio deviation
                const meanRatio = 0.037;
                const stdDev = 0.003;
                const zScore = (ratio - meanRatio) / stdDev;
                
                // Generate consistent price data
                const ethPriceBase = 2200;
                const btcPriceBase = 43000;
                const ethPrice = ethPriceBase + (Math.sin(i * 7.234) * 200); // Deterministic price variation
                const btcPrice = btcPriceBase + (Math.sin(i * 5.678) * 2500); // Deterministic price variation
                
                data.push({
                    date: date.toISOString().split('T')[0],
                    ethBtcRatio: ratio,
                    zScore: zScore,
                    ethPrice: ethPrice,
                    btcPrice: btcPrice
                });
            }
            
            return data;
        }

        function updateHistoricalCharts(historicalData) {
            if (!historicalData || historicalData.length === 0) return;
            
            // Prepare data for charts (last 30 points to prevent overcrowding)
            const chartData = historicalData.slice(-30);
            const labels = chartData.map(d => {
                const date = new Date(d.date || d.timestamp);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            
            // Update ratio chart
            if (ratioChart) {
                ratioChart.data.labels = labels;
                ratioChart.data.datasets[0].data = chartData.map(d => d.ethBtcRatio);
                ratioChart.update('none');
                console.log('üìä Updated ratio chart with', chartData.length, 'points');
            }
            
            // Update Z-score chart
            if (zscoreChart) {
                zscoreChart.data.labels = labels;
                zscoreChart.data.datasets[0].data = chartData.map(d => d.zScore);
                zscoreChart.update('none');
                console.log('üìä Updated Z-score chart with', chartData.length, 'points');
            }
        }

        function updateLastUpdate() {
            const now = new Date();
            document.getElementById('last-update').textContent = 
                now.toLocaleTimeString();
        }

        function updateConnectionStatus(connected = true) {
            const statusElement = document.getElementById('connection-status');
            const dotElement = document.querySelector('.status-dot');
            
            if (connected) {
                statusElement.textContent = 'Connected';
                dotElement.style.background = '#00d4aa';
            } else {
                statusElement.textContent = 'Disconnected';
                dotElement.style.background = '#ff6b6b';
            }
        }

        function refreshData() {
            loadDashboardData();
        }

        function refreshHistoricalData() {
            console.log('üîÑ Manually refreshing historical data...');
            window.historicalDataLoaded = false;
            loadHistoricalCharts();
        }

        // Timeframe selector
        document.querySelectorAll('.timeframe-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.timeframe-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                // TODO: Update chart based on timeframe
                console.log('Timeframe selected:', this.textContent);
            });
        });

        // Backtest Sandbox Functions
        let backtestChart = null;
        let isOptimizing = false;

        function openBacktestSandbox() {
            document.getElementById('backtestSandbox').style.display = 'block';
            document.body.style.overflow = 'hidden';
            
            // Initialize parameter listeners
            initializeParameterListeners();
            
            // Initialize backtest chart
            setTimeout(() => {
                initializeBacktestChart();
            }, 100);
        }

        function closeBacktestSandbox() {
            document.getElementById('backtestSandbox').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function initializeParameterListeners() {
            // Z-Score Threshold
            const zScoreSlider = document.getElementById('zScoreThreshold');
            const zScoreValue = document.getElementById('zScoreValue');
            zScoreSlider.addEventListener('input', function() {
                zScoreValue.textContent = `¬±${this.value}`;
            });

            // Rebalance Percentage
            const rebalanceSlider = document.getElementById('rebalancePercent');
            const rebalanceValue = document.getElementById('rebalanceValue');
            rebalanceSlider.addEventListener('input', function() {
                rebalanceValue.textContent = `${this.value}%`;
            });

            // Lookback Window
            const lookbackSlider = document.getElementById('lookbackWindow');
            const lookbackValue = document.getElementById('lookbackValue');
            lookbackSlider.addEventListener('input', function() {
                lookbackValue.textContent = `${this.value} days`;
            });

            // Transaction Cost
            const transactionSlider = document.getElementById('transactionCost');
            const transactionValue = document.getElementById('transactionValue');
            transactionSlider.addEventListener('input', function() {
                transactionValue.textContent = `${this.value}%`;
            });
        }

        function initializeBacktestChart() {
            const ctx = document.getElementById('backtestChart').getContext('2d');
            
            backtestChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'BTC Accumulation',
                        data: [],
                        borderColor: '#00d4aa',
                        backgroundColor: 'rgba(0, 212, 170, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1
                    }, {
                        label: 'Buy & Hold',
                        data: [],
                        borderColor: '#666',
                        backgroundColor: 'rgba(102, 102, 102, 0.1)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1,
                        borderDash: [5, 5]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 0 },
                    plugins: { 
                        legend: { 
                            display: true,
                            labels: { color: '#b3b3b3' }
                        } 
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: { color: '#2d2d30' },
                            ticks: { color: '#b3b3b3' }
                        },
                        y: {
                            display: true,
                            grid: { color: '#2d2d30' },
                            ticks: {
                                color: '#b3b3b3',
                                callback: function(value) {
                                    return value.toFixed(6) + ' BTC';
                                }
                            }
                        }
                    }
                }
            });
        }

        function getBacktestParameters() {
            return {
                zScoreThreshold: parseFloat(document.getElementById('zScoreThreshold').value),
                rebalancePercent: parseFloat(document.getElementById('rebalancePercent').value),
                lookbackWindow: parseInt(document.getElementById('lookbackWindow').value),
                transactionCost: parseFloat(document.getElementById('transactionCost').value),
                backtestPeriod: parseInt(document.getElementById('backtestPeriod').value),
                startingBTC: parseFloat(document.getElementById('startingBTC').value),
                startingETH: parseFloat(document.getElementById('startingETH').value)
            };
        }

        async function runSingleBacktest() {
            if (isOptimizing) return;

            const params = getBacktestParameters();
            document.getElementById('backtestStatus').textContent = 'Running backtest...';
            
            try {
                const response = await fetch('/api/backtest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'run',
                        parameters: params,
                        outputFormat: 'btc'
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    displayBacktestResults(result.data);
                    document.getElementById('backtestStatus').textContent = 'Backtest completed';
                } else {
                    throw new Error(result.error || 'Backtest failed');
                }
            } catch (error) {
                console.error('Backtest error:', error);
                document.getElementById('backtestStatus').textContent = 'Error: ' + error.message;
            }
        }

        async function runOptimization() {
            if (isOptimizing) return;
            await runOptimizationWithIterations(10);
        }

        async function runAdvancedOptimization() {
            if (isOptimizing) return;
            await runOptimizationWithIterations(100);
        }

        async function runOptimizationWithIterations(iterations) {
            isOptimizing = true;
            document.getElementById('optimizationProgress').style.display = 'block';
            document.getElementById('totalIterations').textContent = iterations;
            document.getElementById('currentIteration').textContent = '0';
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('bestBtcGrowth').textContent = '--';
            
            let bestResult = null;
            let bestParams = null;

            for (let i = 0; i < iterations; i++) {
                document.getElementById('currentIteration').textContent = i + 1;
                document.getElementById('progressBar').style.width = `${((i + 1) / iterations) * 100}%`;
                
                // Generate random parameters around current values
                const baseParams = getBacktestParameters();
                const randomParams = {
                    zScoreThreshold: baseParams.zScoreThreshold + (Math.random() - 0.5) * 1.0,
                    rebalancePercent: Math.max(10, Math.min(90, baseParams.rebalancePercent + (Math.random() - 0.5) * 40)),
                    lookbackWindow: Math.max(5, Math.min(60, baseParams.lookbackWindow + Math.floor((Math.random() - 0.5) * 20))),
                    transactionCost: Math.max(0, Math.min(5, baseParams.transactionCost + (Math.random() - 0.5) * 2)),
                    backtestPeriod: baseParams.backtestPeriod,
                    startingBTC: baseParams.startingBTC,
                    startingETH: baseParams.startingETH
                };

                try {
                    const response = await fetch('/api/backtest', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'run',
                            parameters: randomParams,
                            outputFormat: 'btc'
                        })
                    });

                    const result = await response.json();
                    
                    if (result.success && result.data.performance) {
                        const btcGrowth = result.data.performance.btcGrowthPercent || 0;
                        
                        if (!bestResult || btcGrowth > bestResult.btcGrowthPercent) {
                            bestResult = result.data.performance;
                            bestParams = randomParams;
                            document.getElementById('bestBtcGrowth').textContent = `+${btcGrowth.toFixed(2)}%`;
                        }
                    }
                } catch (error) {
                    console.error(`Optimization iteration ${i + 1} failed:`, error);
                }

                // Small delay to prevent overwhelming the server
                await new Promise(resolve => setTimeout(resolve, 100));
            }

            // Apply best parameters and run final backtest
            if (bestParams) {
                applyParameters(bestParams);
                await runSingleBacktest();
            }

            isOptimizing = false;
            document.getElementById('optimizationProgress').style.display = 'none';
        }

        function applyParameters(params) {
            document.getElementById('zScoreThreshold').value = params.zScoreThreshold;
            document.getElementById('zScoreValue').textContent = `¬±${params.zScoreThreshold.toFixed(3)}`;
            
            document.getElementById('rebalancePercent').value = params.rebalancePercent;
            document.getElementById('rebalanceValue').textContent = `${params.rebalancePercent.toFixed(0)}%`;
            
            document.getElementById('lookbackWindow').value = params.lookbackWindow;
            document.getElementById('lookbackValue').textContent = `${params.lookbackWindow} days`;
            
            document.getElementById('transactionCost').value = params.transactionCost;
            document.getElementById('transactionValue').textContent = `${params.transactionCost.toFixed(2)}%`;
        }

        function loadPreset(preset) {
            const presets = {
                conservative: {
                    zScoreThreshold: 2.0,
                    rebalancePercent: 25,
                    lookbackWindow: 30,
                    transactionCost: 1.0
                },
                megaOptimal: {
                    zScoreThreshold: 1.258,
                    rebalancePercent: 50,
                    lookbackWindow: 15,
                    transactionCost: 1.66
                },
                aggressive: {
                    zScoreThreshold: 0.8,
                    rebalancePercent: 75,
                    lookbackWindow: 7,
                    transactionCost: 2.0
                }
            };

            if (presets[preset]) {
                applyParameters(presets[preset]);
            }
        }

        function displayBacktestResults(results) {
            // Update quick stats
            document.getElementById('btcGrowth').textContent = 
                results.performance ? `+${results.performance.btcGrowthPercent.toFixed(2)}%` : '--';
            document.getElementById('winRate').textContent = 
                results.performance ? `${results.performance.winRate.toFixed(1)}%` : '--';
            document.getElementById('totalTrades').textContent = 
                results.trades ? results.trades.length : '--';
            document.getElementById('maxDrawdown').textContent = 
                results.performance ? `${results.performance.maxDrawdown.toFixed(2)}%` : '--';

            // Update chart
            if (results.portfolio && backtestChart) {
                const dates = results.portfolio.map(p => new Date(p.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                const btcValues = results.portfolio.map(p => p.totalBTC);
                const hodlValues = results.portfolio.map(p => p.hodlBTC);

                backtestChart.data.labels = dates;
                backtestChart.data.datasets[0].data = btcValues;
                backtestChart.data.datasets[1].data = hodlValues;
                backtestChart.update('none');
            }

            // Update trade log
            if (results.trades) {
                const tradeLogContent = document.getElementById('tradeLogContent');
                const recentTrades = results.trades.slice(-10).reverse();
                
                tradeLogContent.innerHTML = recentTrades.map(trade => `
                    <div style="display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #2d2d30; font-size: 14px;">
                        <span style="color: ${trade.action === 'BUY_ETH' ? '#00d4aa' : '#ff6b6b'};">
                            ${trade.action}
                        </span>
                        <span style="color: #b3b3b3;">
                            ${new Date(trade.date).toLocaleDateString()}
                        </span>
                        <span style="color: #fbbf24;">
                            ${trade.btcGrowth > 0 ? '+' : ''}${trade.btcGrowth.toFixed(4)} BTC
                        </span>
                    </div>
                `).join('');
            }
        }
    </script>
</body>
</html>