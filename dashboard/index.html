<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETH/BTC Trading System - Live Dashboard</title>
    <!-- Cirrus UI CSS Framework -->
    <link rel="stylesheet" href="https://unpkg.com/cirrus-ui@0.7.1/dist/cirrus.min.css">
    
    <!-- React and other dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* Custom styles to complement Cirrus UI */
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .trading-header {
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .status-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online {
            background: #10b981;
        }

        .status-offline {
            background: #ef4444;
        }

        .metric-value {
            font-size: 2.5rem !important;
            font-weight: 700 !important;
            color: #3b82f6 !important;
        }

        .signal-card {
            background: linear-gradient(135deg, var(--signal-from), var(--signal-to));
            color: white;
            text-align: center;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .signal-buy {
            --signal-from: #10b981;
            --signal-to: #059669;
        }

        .signal-sell {
            --signal-from: #ef4444;
            --signal-to: #dc2626;
        }

        .signal-hold {
            --signal-from: #3b82f6;
            --signal-to: #2563eb;
        }

        .allocation-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        .allocation-item {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 6px;
            text-align: center;
        }

        .chart-container {
            height: 300px;
            margin-top: 1rem;
        }

        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Trading Dashboard Component
        function TradingDashboard() {
            const [portfolioData, setPortfolioData] = useState(null);
            const [signalData, setSignalData] = useState(null);
            const [recentTrades, setRecentTrades] = useState([]);
            const [systemStatus, setSystemStatus] = useState('loading');
            const [lastUpdated, setLastUpdated] = useState(null);
            const [error, setError] = useState(null);

            const ratioChartRef = useRef(null);
            const performanceChartRef = useRef(null);

            // Load initial data
            useEffect(() => {
                loadDashboardData();
                
                // Set up auto-refresh every 30 seconds
                const interval = setInterval(loadDashboardData, 30000);
                
                return () => clearInterval(interval);
            }, []);

            const loadDashboardData = async () => {
                try {
                    setError(null);
                    
                    // Load current signal
                    const signalResponse = await fetch('/api/signal');
                    const signalData = await signalResponse.json();
                    
                    if (signalResponse.ok) {
                        setSignalData(signalData);
                        setSystemStatus('online');
                    } else {
                        throw new Error(signalData.message || 'Failed to load signal');
                    }

                    // Load portfolio (this might fail if not initialized)
                    try {
                        const portfolioResponse = await fetch('/api/portfolio');
                        const portfolioData = await portfolioResponse.json();
                        
                        if (portfolioResponse.ok) {
                            setPortfolioData(portfolioData);
                        }
                    } catch (portfolioError) {
                        console.log('Portfolio not initialized yet');
                    }

                    // Mock recent trades (in production, load from database)
                    setRecentTrades([
                        {
                            id: 1,
                            timestamp: new Date(Date.now() - 3600000).toISOString(),
                            action: 'SELL_ETH_BUY_BTC',
                            amount: '0.1234',
                            price: '0.063247',
                            pnl: '+142'
                        },
                        {
                            id: 2,
                            timestamp: new Date(Date.now() - 7200000).toISOString(),
                            action: 'BUY_ETH_SELL_BTC',
                            amount: '0.0987',
                            price: '0.062891',
                            pnl: '+89'
                        }
                    ]);

                    setLastUpdated(new Date());

                } catch (error) {
                    console.error('Dashboard load error:', error);
                    setError(error.message);
                    setSystemStatus('offline');
                }
            };

            const formatTime = (timestamp) => {
                return new Date(timestamp).toLocaleTimeString();
            };

            const formatDate = (timestamp) => {
                return new Date(timestamp).toLocaleDateString();
            };

            if (error) {
                return (
                    <div className="container">
                        <div className="frame bg-red-100 border-red-200 p-6 text-center">
                            <div className="tile">
                                <div className="tile__icon">
                                    <i className="fas fa-exclamation-triangle text-red-500 text-2xl"></i>
                                </div>
                                <div className="tile__container">
                                    <p className="tile__title text-red-700">Dashboard Error</p>
                                    <p className="tile__subtitle text-red-600">{error}</p>
                                    <button className="btn btn-primary mt-3" onClick={loadDashboardData}>
                                        <i className="fas fa-redo mr-2"></i>Retry
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="container">
                    {/* Header */}
                    <div className="hero hero-sm">
                        <div className="hero-body">
                            <div className="content u-text-center text-white trading-header">
                                <h1 className="title">
                                    <span className={`status-dot ${systemStatus === 'online' ? 'status-online' : 'status-offline'}`}></span>
                                    <i className="fab fa-ethereum mr-2"></i>ETH/BTC Trading System
                                </h1>
                                <h6 className="subtitle text-white opacity-75">
                                    <i className="fas fa-brain mr-2"></i>Mega-Optimal Strategy â€¢ Live Dashboard
                                </h6>
                            </div>
                        </div>
                    </div>

                    {/* Main Dashboard Grid */}
                    <div className="row">
                        <div className="col-6 col-lg-3">
                            {/* Current Signal */}
                            <div className="frame p-0 mb-3">
                                <div className="frame__header p-3">
                                    <div className="frame__title">
                                        <i className="fas fa-chart-line mr-2"></i>Trading Signal
                                    </div>
                                </div>
                                <div className="frame__body p-3">
                                    {signalData ? (
                                        <>
                                            <div className={`signal-card signal-${signalData.signal?.shouldTrade ? 
                                                (signalData.signal.action.includes('BUY_ETH') ? 'buy' : 'sell') : 'hold'}`}>
                                                <div className="u-text-lg font-bold">
                                                    {signalData.signal?.shouldTrade ? 
                                                        signalData.signal.action.replace('_', ' ') : 'HOLD POSITION'}
                                                </div>
                                            </div>
                                            <div className="content u-text-center mb-2">
                                                <div className="metric-value">{signalData.currentMarket?.ethBtcRatio?.toFixed(6) || '--'}</div>
                                                <p className="text-gray-600 text-xs uppercase">ETH/BTC Ratio</p>
                                            </div>
                                            <div className="row">
                                                <div className="col-6 u-text-center">
                                                    <div className="u-text-lg font-bold text-blue-600">
                                                        {signalData.signal?.zScore?.toFixed(3) || '--'}
                                                    </div>
                                                    <p className="text-gray-600 text-xs">Z-Score</p>
                                                </div>
                                                <div className="col-6 u-text-center">
                                                    <div className="u-text-lg font-bold text-blue-600">
                                                        {((signalData.signal?.confidence || 0) * 100).toFixed(1)}%
                                                    </div>
                                                    <p className="text-gray-600 text-xs">Confidence</p>
                                                </div>
                                            </div>
                                        </>
                                    ) : (
                                        <div className="content u-text-center animate-pulse">
                                            <i className="fas fa-spinner fa-spin text-blue-500 text-2xl"></i>
                                            <p className="text-gray-500 mt-2">Loading signal...</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        <div className="col-6 col-lg-3">
                            {/* Portfolio Status */}
                            <div className="frame p-0 mb-3">
                                <div className="frame__header p-3">
                                    <div className="frame__title">
                                        <i className="fas fa-wallet mr-2"></i>Portfolio Status
                                    </div>
                                </div>
                                <div className="frame__body p-3">
                                    {portfolioData?.portfolio ? (
                                        <>
                                            <div className="content u-text-center mb-3">
                                                <div className="metric-value">{portfolioData.portfolio.totalValueBTC}</div>
                                                <p className="text-gray-600 text-xs uppercase">Total Value BTC</p>
                                            </div>
                                            <div className="allocation-grid">
                                                <div className="allocation-item">
                                                    <div className="u-text-lg font-bold text-gray-800">
                                                        {portfolioData.portfolio.ethAmount}
                                                    </div>
                                                    <div className="text-xs text-gray-600 uppercase">ETH</div>
                                                </div>
                                                <div className="allocation-item">
                                                    <div className="u-text-lg font-bold text-gray-800">
                                                        {portfolioData.portfolio.btcAmount}
                                                    </div>
                                                    <div className="text-xs text-gray-600 uppercase">BTC</div>
                                                </div>
                                            </div>
                                            <div className="allocation-grid mt-2">
                                                <div className="allocation-item">
                                                    <div className="u-text-sm font-bold text-blue-600">
                                                        {portfolioData.portfolio.allocation?.ethPercent || '--'}
                                                    </div>
                                                    <div className="text-xs text-gray-600">ETH %</div>
                                                </div>
                                                <div className="allocation-item">
                                                    <div className="u-text-sm font-bold text-blue-600">
                                                        {portfolioData.portfolio.allocation?.btcPercent || '--'}
                                                    </div>
                                                    <div className="text-xs text-gray-600">BTC %</div>
                                                </div>
                                            </div>
                                        </>
                                    ) : (
                                        <div className="content u-text-center">
                                            <i className="fas fa-exclamation-circle text-yellow-500 text-2xl"></i>
                                            <p className="text-gray-500 mt-2">Portfolio not initialized</p>
                                            <p className="text-xs text-gray-400">Use API to initialize portfolio</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        <div className="col-6 col-lg-3">
                            {/* Market Data */}
                            <div className="frame p-0 mb-3">
                                <div className="frame__header p-3">
                                    <div className="frame__title">
                                        <i className="fas fa-chart-bar mr-2"></i>Market Data
                                    </div>
                                </div>
                                <div className="frame__body p-3">
                                    {signalData?.currentMarket ? (
                                        <>
                                            <div className="content u-text-center mb-2">
                                                <div className="u-text-lg font-bold text-green-600">
                                                    ${signalData.currentMarket.ethPrice?.toLocaleString() || '--'}
                                                </div>
                                                <p className="text-gray-600 text-xs uppercase">ETH Price</p>
                                            </div>
                                            <div className="content u-text-center mb-2">
                                                <div className="u-text-lg font-bold text-orange-500">
                                                    ${signalData.currentMarket.btcPrice?.toLocaleString() || '--'}
                                                </div>
                                                <p className="text-gray-600 text-xs uppercase">BTC Price</p>
                                            </div>
                                            <div className="content u-text-center">
                                                <div className="u-text-sm font-bold text-gray-600">
                                                    {Math.round((signalData.currentMarket.dataAge || 0) / 1000)}s ago
                                                </div>
                                                <p className="text-gray-600 text-xs uppercase">Data Age</p>
                                            </div>
                                        </>
                                    ) : (
                                        <div className="content u-text-center animate-pulse">
                                            <i className="fas fa-spinner fa-spin text-blue-500 text-2xl"></i>
                                            <p className="text-gray-500 mt-2">Loading market data...</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        <div className="col-6 col-lg-3">
                            {/* Strategy Parameters */}
                            <div className="frame p-0 mb-3">
                                <div className="frame__header p-3">
                                    <div className="frame__title">
                                        <i className="fas fa-cogs mr-2"></i>Strategy Settings
                                    </div>
                                </div>
                                <div className="frame__body p-3">
                                    {signalData?.strategy ? (
                                        <div className="space-y-3">
                                            <div className="content u-text-center">
                                                <div className="u-text-lg font-bold text-purple-600">
                                                    {signalData.strategy.zScoreThreshold?.toFixed(3) || '--'}
                                                </div>
                                                <p className="text-gray-600 text-xs uppercase">Z-Score Threshold</p>
                                            </div>
                                            <div className="content u-text-center">
                                                <div className="u-text-lg font-bold text-purple-600">
                                                    {signalData.strategy.rebalanceAmount || '--'}
                                                </div>
                                                <p className="text-gray-600 text-xs uppercase">Rebalance Amount</p>
                                            </div>
                                            <div className="content u-text-center">
                                                <div className="u-text-lg font-bold text-purple-600">
                                                    {signalData.strategy.transactionCost || '--'}
                                                </div>
                                                <p className="text-gray-600 text-xs uppercase">Transaction Cost</p>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="content u-text-center animate-pulse">
                                            <i className="fas fa-spinner fa-spin text-blue-500 text-2xl"></i>
                                            <p className="text-gray-500 mt-2">Loading strategy...</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Recent Trades Table */}
                    <div className="frame p-0 mb-3">
                        <div className="frame__header p-3">
                            <div className="frame__title">
                                <i className="fas fa-history mr-2"></i>Recent Trading Activity
                            </div>
                        </div>
                        <div className="frame__body p-0">
                            {recentTrades.length > 0 ? (
                                <table className="table">
                                    <thead>
                                        <tr>
                                            <th>Time</th>
                                            <th>Action</th>
                                            <th>Amount</th>
                                            <th>Price</th>
                                            <th>P&L (Sats)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {recentTrades.map(trade => (
                                            <tr key={trade.id}>
                                                <td>{formatTime(trade.timestamp)}</td>
                                                <td>
                                                    <span className={`tag ${trade.action.includes('BUY_ETH') ? 'tag-success' : 'tag-danger'}`}>
                                                        {trade.action.replace('_', ' ')}
                                                    </span>
                                                </td>
                                                <td className="font-mono">{trade.amount}</td>
                                                <td className="font-mono">{trade.price}</td>
                                                <td className={`font-mono ${trade.pnl.startsWith('+') ? 'text-green-600' : 'text-red-600'}`}>
                                                    {trade.pnl}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            ) : (
                                <div className="content u-text-center p-6">
                                    <i className="fas fa-chart-line text-gray-400 text-3xl"></i>
                                    <p className="text-gray-500 mt-2">No recent trades</p>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* System Controls */}
                    <div className="frame p-0 mb-3">
                        <div className="frame__header p-3">
                            <div className="frame__title">
                                <i className="fas fa-tools mr-2"></i>System Controls
                            </div>
                        </div>
                        <div className="frame__body p-3">
                            <div className="content u-text-center">
                                <div className="btn-group">
                                    <button className="btn btn-primary" onClick={loadDashboardData}>
                                        <i className="fas fa-sync-alt mr-2"></i>Refresh Data
                                    </button>
                                    <button className="btn btn-info" onClick={() => window.open('/api/backtest', '_blank')}>
                                        <i className="fas fa-chart-area mr-2"></i>Run Backtest
                                    </button>
                                    <button className="btn btn-success" onClick={() => window.open('/api/signal', '_blank')}>
                                        <i className="fas fa-bullseye mr-2"></i>Get Signal
                                    </button>
                                </div>
                                {lastUpdated && (
                                    <p className="text-gray-500 text-sm mt-3">
                                        <i className="fas fa-clock mr-1"></i>
                                        Last updated: {lastUpdated.toLocaleTimeString()}
                                    </p>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Render the dashboard
        ReactDOM.render(<TradingDashboard />, document.getElementById('root'));
    </script>
</body>
</html>
